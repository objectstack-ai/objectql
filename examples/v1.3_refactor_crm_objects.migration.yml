# Example Migration File: Refactor CRM Objects
# File: v1.3_refactor_crm_objects.migration.yml
#
# This migration demonstrates object-level operations including
# renaming objects and removing deprecated objects.

version: 1.3.0
name: Refactor CRM Objects
description: |
  Update CRM object naming to align with industry standards.
  Rename 'customers' to 'accounts' and remove obsolete 'temp_leads' object.

author: product-team
created_at: 2026-01-20T00:00:00Z

steps:
  # Step 1: Update customer object metadata
  - id: step_1
    name: Update customer object properties
    description: Update label and description before rename
    
    instruction:
      type: object_update
      object_name: customers
      
      # Changes to apply to the object (excluding rename)
      changes:
        label: Account
        description: Business accounts and customer records
        icon: standard:account
      
      description: Update object metadata
      reason: Prepare for rename to accounts
      timestamp: 2026-01-20T10:00:00Z
    
    reversible: true

  # Step 2: Rename customer to account
  - id: step_2
    name: Rename customers to accounts
    description: Rename object for CRM consistency
    
    instruction:
      type: object_update
      object_name: customers
      new_object_name: accounts
      
      changes:
        label: Account
        description: Business accounts for CRM
      
      description: Rename object for standard CRM terminology
      reason: Align with Salesforce-like CRM naming conventions
      timestamp: 2026-01-20T11:00:00Z
    
    reversible: true
    depends_on:
      - step_1

  # Step 3: Remove temporary leads table
  - id: step_3
    name: Remove temp_leads object
    description: Clean up temporary lead import table
    
    instruction:
      type: object_delete
      object_name: temp_leads
      
      # Archive entire object data before deletion
      deletion_strategy: archive
      archive_location: backups/temp_leads_archive
      
      # Handle related records
      cascade_strategy: nullify
      
      description: Remove temporary lead import staging table
      reason: Migration to new lead system complete
      timestamp: 2026-01-20T12:00:00Z
    
    reversible: true
    depends_on:
      - step_2

  # Step 4: Remove old_customers table permanently
  - id: step_4
    name: Drop old_customers object
    description: Permanently remove legacy customer table
    
    instruction:
      type: object_delete
      object_name: old_customers
      
      # Permanent deletion with cascade
      deletion_strategy: drop
      cascade_strategy: cascade
      
      description: Remove legacy customer table
      reason: All data migrated to new accounts object
      timestamp: 2026-01-20T13:00:00Z
    
    # Cannot be rolled back
    reversible: false
    depends_on:
      - step_3

reversible: false  # Overall not reversible due to step_4
depends_on:
  - v1.2_convert_price_to_currency  # Depends on previous migration

tags:
  - refactor
  - crm
  - breaking-change
  - object-rename

# ========================================
# Object Deletion Cascade Strategies
# ========================================

# cascade_strategy: cascade
#   - Deletes all related records in other objects
#   - Use with caution (irreversible data loss)
#   - Best for truly obsolete data

# cascade_strategy: fail
#   - Migration fails if dependent records exist
#   - Safest option to prevent accidental data loss
#   - Forces manual cleanup first

# cascade_strategy: nullify
#   - Sets foreign key references to null
#   - Preserves related records
#   - Recommended for most cases

# ========================================
# Object Update vs Rename
# ========================================

# When to use object_update with new_object_name:
#   - Renaming the object API name
#   - Affects all queries, APIs, and references
#   - Database table name also changes

# When to use object_update with changes only:
#   - Updating metadata (label, icon, description)
#   - No impact on queries or API
#   - Database structure unchanged
