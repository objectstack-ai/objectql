# File: crm_opportunity.object.yml
# Object name is inferred from filename as 'crm_opportunity'
label: Opportunity
description: Sales opportunity or deal
icon: currency-line

ai_context:
  intent: "Track and manage active sales opportunities through the pipeline"
  domain: customer_relationship_management
  aliases: [opportunity, deal, sales opportunity]
  common_queries:
    - "Show my open opportunities"
    - "Find opportunities closing this quarter"
    - "List high-value deals by stage"

fields:
  name:
    type: text
    required: true
    label: Opportunity Name
    index: true
    ai_context:
      intent: "Descriptive name of the sales opportunity"
  
  account:
    type: lookup
    reference_to: crm_account
    label: Account
    required: true
    index: true
    ai_context:
      intent: "Customer organization for this opportunity"
      semantic_type: hierarchy
  
  amount:
    type: currency
    label: Amount
    required: true
  
  close_date:
    type: date
    label: Expected Close Date
    required: true
    index: true
  
  stage:
    type: select
    label: Sales Stage
    options:
      - label: Prospecting
        value: prospecting
      - label: Qualification
        value: qualification
      - label: Proposal
        value: proposal
      - label: Negotiation
        value: negotiation
      - label: Closed Won
        value: closed_won
      - label: Closed Lost
        value: closed_lost
    defaultValue: prospecting
    required: true
    index: true
    ai_context:
      intent: "Current stage in the sales pipeline"
      is_state_machine: true
      transitions:
        prospecting: [qualification, closed_lost]
        qualification: [proposal, closed_lost]
        proposal: [negotiation, closed_lost]
        negotiation: [closed_won, closed_lost]
        closed_won: []
        closed_lost: []
  
  probability:
    type: percent
    label: Probability (%)
    min: 0
    max: 100
  
  type:
    type: select
    options:
      - label: New Business
        value: new_business
      - label: Existing Customer
        value: existing_customer
      - label: Renewal
        value: renewal
    label: Opportunity Type
    index: true
    ai_context:
      intent: "Categorize revenue type for forecasting"
      selection_guidance: "New Business for new customers; Renewal for contract renewals"
  
  lead_source:
    type: select
    options:
      - label: Web
        value: web
      - label: Referral
        value: referral
      - label: Trade Show
        value: trade_show
      - label: Partner
        value: partner
      - label: Cold Call
        value: cold_call
      - label: Other
        value: other
    label: Lead Source
    index: true
    ai_context:
      intent: "Original source for ROI tracking"
  
  owner:
    type: lookup
    reference_to: user
    label: Opportunity Owner
    required: true
    index: true
    ai_context:
      intent: "Sales representative managing this opportunity"
      semantic_type: ownership
  
  next_step:
    type: text
    label: Next Step
  
  description:
    type: textarea
    label: Description
  
  competitors:
    type: textarea
    label: Known Competitors

indexes:
  # For pipeline reports
  stage_close_date_idx:
    fields: [stage, close_date]
  
  # For owner queries
  owner_stage_idx:
    fields: [owner, stage]
  
  # For forecasting
  close_date_amount_idx:
    fields: [close_date, amount]
  
  # For account opportunity history
  account_stage_idx:
    fields: [account, stage]

ai:
  search:
    enabled: true
    fields: [name, description, next_step]
    model: text-embedding-3-small

actions:
  mark_won:
    type: record
    label: Mark as Won
    icon: checkbox-circle-line
    confirm_text: "Mark this opportunity as won?"
  
  mark_lost:
    type: record
    label: Mark as Lost
    icon: close-circle-line
    confirm_text: "Mark this opportunity as lost?"
    params:
      reason:
        type: textarea
        label: Loss Reason
        required: true
